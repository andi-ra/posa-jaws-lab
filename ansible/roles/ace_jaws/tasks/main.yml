---
- name: Install extraction tools (Alpine)
  community.general.apk:
    name:
      - tar
      - unzip
      - ca-certificates
    state: present
    update_cache: true

- name: Create ACE install root
  file:
    path: "{{ ace_install_root }}"
    state: directory
    mode: "0755"

- name: Download ACE+TAO full bundle (includes ACE_wrappers)
  get_url:
    url: "{{ ace_tao_url }}"
    dest: "/tmp/ACE+TAO.tar.gz"
    mode: "0644"

- name: Assert bundle contains JAWS
  shell: |
    set -e
    tar -tzf /tmp/ACE+TAO.tar.gz | grep -q '^ACE_wrappers/apps/JAWS/'
  args:
    executable: /bin/sh

- name: Extract ACE+TAO (creates /opt/ace/ACE_wrappers)
  shell: |
    set -e
    cd "{{ ace_install_root }}"
    tar -xzf /tmp/ACE+TAO.tar.gz
    test -d "{{ ace_install_root }}/ACE_wrappers"
  args:
    executable: /bin/sh
  changed_when: false

- name: Symlink ACE_TAO -> ACE_wrappers
  file:
    src: "{{ ace_install_root }}/ACE_wrappers"
    dest: "{{ ace_link_dir }}"
    state: link
    force: true

- name: Ensure include/makeinclude exists
  stat:
    path: "{{ ace_root }}/include/makeinclude"
  register: mkinc
  failed_when: not mkinc.stat.exists

- name: Ensure ace/ exists
  stat:
    path: "{{ ace_root }}/ace"
  register: acedir
  failed_when: not acedir.stat.exists

- name: Ensure ace/config.h exists
  shell: |
    set -e
    cd "{{ ace_root }}/ace"
    if [ -f config.h ]; then exit 0; fi
    if [ -f config-linux.h ]; then printf '#include "config-linux.h"\n' > config.h; exit 0; fi
    if [ -f config.h.in ]; then cp -f config.h.in config.h; exit 0; fi
    printf '/* minimal config.h */\n' > config.h
  args:
    executable: /bin/sh

- name: Write platform_macros.GNU
  template:
    src: platform_macros.GNU.j2
    dest: "{{ ace_root }}/include/makeinclude/platform_macros.GNU"
    mode: "0644"

- name: Build ACE (ace/)
  shell: |
    set -e
    export ACE_ROOT="{{ ace_root }}"
    make -C "{{ ace_root }}/ace" -j{{ ace_make_jobs }} {{ 'debug=1 optimize=0' if ace_debug_build else '' }}
  args:
    executable: /bin/sh
  tags: [build]

- name: Build JAWS server
  shell: |
    set -e
    test -d "{{ jaws_server_dir }}"
    export ACE_ROOT="{{ ace_root }}"
    make -C "{{ jaws_server_dir }}" -j{{ ace_make_jobs }} {{ 'debug=1 optimize=0' if ace_debug_build else '' }}
  args:
    executable: /bin/sh
  tags: [build]
